### **Название задачи:** ADR-002: Централизованное управление ставками и их передача в кол-центры
### **Автор:** Алексей Гредяев
### **Дата:** 2025-09-04
### **Контекст**
Данное решение является дополнением к **[ADR-001](../Task3/ADR-001-Online-Deposits-MVP.md)** и детализирует интеграцию **"Сервиса Ставок"** с кол-центрами и онлайн-каналами (Сайт, Интернет-банк).

### **Функциональные требования**

|**№**|**Действующие лица или системы**|**Use Case**|**Описание**|
| :-: | :- | :- | :- |
|1|Сотрудник бэк-офиса (депозиты)|Управление ставками|Сотрудник, после аутентификации и авторизации, входит в веб-интерфейс "Сервиса Ставок". Он может создавать новые, редактировать существующие и архивировать старые ставки по депозитам. Каждая ставка имеет набор параметров (срок, сумма, тип клиента и т.д.).|
|2|Система кол-центра, **API Gateway**|Получение актуальных ставок|Система кол-центра, используя аутентификацию по токену (JWT), обращается к **API Gateway**, который проксирует запрос к REST API "Сервиса Ставок" для получения актуальной сетки ставок. Ответ должен быть в формате JSON.|
|3|"Сервис Ставок", Система партнёрского кол-центра|Экспорт ставок для партнера|Каждый час "Сервис Ставок" генерирует CSV-файл с заголовками, содержащий полную сетку актуальных ставок, и выгружает его на SFTP-сервер в директорию партнера.|
|4|Сайт, Интернет-банк, **API Gateway**|Получение публичных и персональных ставок|Онлайн-каналы через **API Gateway** запрашивают у "Сервиса Ставок" актуальные ставки для отображения клиентам.|

### **Нефункциональные требования**

|**№**|**Требование**|
| :-: | :- |
|1|**Надежность (Availability):** Доступность сервиса должна составлять 99.9% (не более 8.76 часов простоя в год).|
|2|**Безопасность (Security):** Аутентификация в UI - через корпоративный SSO. Доступ к API через **API Gateway** - по JWT токенам. Передача файла - по протоколу SFTP с аутентификацией по ключам.|
|3|**Производительность (Performance):** Время ответа REST API на запрос получения ставок (включая задержку на API Gateway) не должно превышать 200 мс при 95-м перцентиле.|
|4|**Масштабируемость (Scalability):** Сервис должен быть развернут в виде минимум двух экземпляров (горизонтальное масштабирование) для обеспечения отказоустойчивости.|
|5|**Сопровождаемость (Maintainability):** Код должен быть покрыт unit-тестами не менее чем на 80%. API должно быть документировано в формате OpenAPI 3.0.|
|6|**Кэширование (Caching):** Ответы API на получение списка ставок должны кэшироваться на уровне API Gateway на 5 минут для снижения нагрузки на сервис.|

### **Решение**
Предлагается использовать микросервис **"Сервис Ставок"**, определенный в ADR-001. Этот сервис станет центральным компонентом для управления и распространения информации о депозитных ставках.

#### Диаграммы
*   **[Диаграмма системного ландшафта (C4 Level 1)](./C4_Context_Rates_Service.puml)**
*   **[Диаграмма компонентов "Сервиса Ставок" (C4 Level 3)](./C4_Container_Rates_Service.puml)**

#### Обоснование решения
Выбор микросервисной архитектуры для "Сервиса Ставок" обусловлен необходимостью изолировать новую бизнес-функцию от монолитной АБС.

Интеграция с Системой кол-центра через **API Gateway** и далее REST API обеспечивает синхронную доставку данных с низкой задержкой и соответствует принятому архитектурному паттерну "единой точки входа". Для партнерского кол-центра, из-за технологических ограничений на их стороне, выбран механизм выгрузки CSV-файла на SFTP-сервер.

### **Альтернативы**
1.  **Доработка АБС:**
    *   **Описание:** Реализовать функционал управления ставками непосредственно в АБС.
    *   **Недостатки:** Долго, дорого, рискованно. АБС перегружена.

2.  **Прямая интеграция с "Сервисом Ставок" в обход API Gateway:**
    *   **Описание:** Разрешить Системе КЦ обращаться к API "Сервиса Ставок" напрямую.
    *   **Недостатки:** Нарушает принятый архитектурный паттерн. Усложняет управление безопасностью и мониторинг.

### **Недостатки, ограничения, риски**
*   **Недостатки:** Появляется новый сервис, который необходимо разрабатывать, поддерживать и мониторить.
*   **Ограничения:** Отсутствуют.
*   **Риски:** Возможны задержки в доработке Системы кол-центра со стороны подрядчика для интеграции с **API Gateway**. Необходимо обеспечить безопасность SFTP-сервера и процесса передачи файлов.