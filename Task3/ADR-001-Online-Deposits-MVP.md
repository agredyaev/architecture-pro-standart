### **Название задачи:** ADR-001: Концептуальная архитектура MVP "Открытие депозитов онлайн"
### **Автор:** Алексей Гредяев
### **Дата:** 2025-09-04
### **Функциональные требования**

|**№**|**Действующие лица или системы**|**Use Case**|**Описание**|
| :-: | :- | :- | :- |
|UC-1|Новый клиент, Сайт, API Gateway, Deposit Service|Подача заявки на депозит с сайта|1. Клиент заходит на сайт, видит список депозитов. 2. Выбирает депозит, вводит ФИО и телефон. 3. Отправляет заявку через **API Gateway**. 4. Заявка попадает в **Deposit Service**. 5. Сотрудник бэк-офиса видит заявку в UI Deposit Service.|
|UC-2|Существующий клиент, Интернет-банк, OTP Service|Подача заявки на депозит из ИБ|1. Клиент в ИБ выбирает депозит, счет и сумму. 2. ИБ вызывает **OTP Service** для генерации и отправки СМС-кода. 3. Клиент вводит полученный код. 4. ИБ вызывает **OTP Service** для валидации кода. 5. После успешной валидации ИБ через **API Gateway** создает заявку в **Deposit Service**.|
|UC-3|Сотрудник бэк-офиса, Deposit Service|Обработка онлайн-заявки|1. Сотрудник заходит в интерфейс Deposit Service. 2. Видит список новых заявок. 3. Открывает заявку, проверяет данные. 4. Подтверждает или отклоняет заявку. 5. Статус заявки обновляется и отправляется в АБС для финальных проводок.|
|UC-4|Сотрудник бэк-офиса, Rate Service|Управление ставками|1. Сотрудник заходит в интерфейс Rate Service. 2. Создает/редактирует/архивирует ставки по депозитам. 3. Система сохраняет изменения с указанием автора и времени.|
|UC-5|Система КЦ, API Gateway, Rate Service|Получение ставок для консультации|1. Система КЦ обращается к API Gateway для получения актуальной сетки ставок. 2. API Gateway проксирует запрос к Rate Service. 3. Rate Service возвращает данные в формате JSON.|
|UC-6|Rate Service, Система партнёрского КЦ|Экспорт ставок для партнера|1. По расписанию (каждый час) Rate Service генерирует CSV-файл с актуальными ставками. 2. Rate Service выгружает файл на SFTP-сервер партнера.|

### **Нефункциональные требования**
Этот раздел ссылается на финальный список требований, зафиксированный в **Task2/FURPS_plus.md**. Ключевые архитектурно-значимые требования для данного решения: **R-01, P-01, +R-01, +R-02, +R-05, +R-09**.

### **Решение**

Предлагаемое решение основано на микросервисной архитектуре и принципе изоляции ядра АБС для минимизации рисков производительности и доступности.

Архитектура решения включает в себя два новых компонента с собственными базами данных и один компонент-фасад:
1.  **Rate Service:** Микросервис с собственной БД (PostgreSQL) для хранения и управления всей информацией о депозитных ставках. Предоставляет REST API для фронтальных систем и внутреннего использования. Реализует требования **F-05, F-05.1, F-07, UC-4, UC-5, UC-6**.
2.  **Deposit Service:** Микросервис с собственной БД (PostgreSQL), который является **мастер-системой** для онлайн-заявок на депозиты. Он оркестрирует процесс, предоставляет UI для бэк-офиса и асинхронно интегрируется с АБС. Реализует **UC-3** и **+R-02**.
3.  **API Gateway:** Фасад, обеспечивающий единую точку входа для онлайн-каналов (Сайт, ИБ) и внутренних систем (Система КЦ). Проксирует запросы к Rate Service и Deposit Service.
4.  **OTP Service:** Микросервис, отвечающий за генерацию, отправку и валидацию одноразовых СМС-кодов для подтверждения операций. Реализует требование **F-03**.

#### Диаграммы

*   **[Диаграмма контекста (C4 Level 1, TO-BE)](./C4_Context_TO_BE.puml)**
*   **[Диаграмма контейнеров (C4 Level 2, TO-BE)](./C4_Containers_TO_BE.puml)**

#### Обоснование решения

**Основная последовательность вызовов для UC-2 (заявка из ИБ):**
1.  **Интернет-банк** через **API Gateway** вызывает **Rate Service** для получения персональных ставок.
2.  **Интернет-банк** вызывает **OTP Service** для отправки и последующей валидации СМС-кода.
3.  После успешной валидации **Интернет-банк** через **API Gateway** вызывает **Deposit Service** для создания заявки.
4.  **Deposit Service** сохраняет заявку в своей БД и отправляет асинхронное сообщение (через **Kafka**) в **АБС** о новой заявке.
5.  Сотрудник бэк-офиса обрабатывает заявку в UI **Deposit Service**.
6.  После финального решения **Deposit Service** отправляет команду в **АБС** на открытие счета.

**Обоснование:**
*   **Единая точка входа:** Все потребители данных (ИБ, Сайт, Система КЦ) работают через API Gateway, что упрощает управление безопасностью, мониторинг и версионирование API.
*   **Изоляция АБС:** Асинхронная интеграция через Kafka полностью устраняет прямую нагрузку на АБС в момент пиковой активности клиентов, реализуя **+R-01**.
*   **Надежность и владение данными:** Каждый сервис владеет своими данными (**+R-02**). Сбой в АБС не приведет к потере онлайн-заявок.

### **Альтернативы**

1.  **Доработка АБС:**
    *   *Причина отказа:* Долго, дорого, рискованно. Не решает проблему производительности.

### **Недостатки, ограничения, риски**

*   **Недостатки:**
    *   **Гарантированная доставка:** Для обеспечения атомарности между сохранением заявки в БД Deposit Service и отправкой события в Kafka, необходимо реализовать паттерн **Transactional Outbox**. Это исключит риск потери сообщений при сбое одной из систем.
    *   **Отказоустойчивость шлюза:** API Gateway является единой точкой входа и должен быть развернут в кластерной, отказоустойчивой конфигурации для соответствия требованию доступности R-01.
*   **Риски:**
    *   **Риск консистентности данных:** Возможны расхождения данных между Deposit Service и АБС. Требуется разработка процессов сверки и разрешения конфликтов.
    *   **Риск интеграции с КЦ:** Возможны задержки в доработке Системы кол-центра со стороны подрядчика для интеграции с API Gateway.