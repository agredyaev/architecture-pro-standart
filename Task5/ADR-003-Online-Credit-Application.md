### **Название задачи:** Архитектурное решение для подачи онлайн-заявки на кредит
### **Автор:** Алексей Гредяев
### **Дата:** 2025-09-04
### **Функциональные требования**

|**№**|**Действующие лица или системы**|**Use Case**|**Описание**|
| :-: | :- | :- | :- |
| 1 | Новый клиент, Сайт, Сервис Заявок, Система скоринга, БКИ | Синхронная предварительная оценка заявки | 1. Клиент на Сайте заполняет анкету (ФИО, телефон, паспортные данные). <br> 2. Сайт через API Gateway отправляет запрос в "Сервис Заявок на Кредит". <br> 3. "Сервис Заявок" синхронно вызывает "Систему скоринга" для предварительной оценки. <br> 4. "Система скоринга" запрашивает данные из БКИ. <br> 5. Клиент получает на Сайте предварительное решение в реальном времени. |
| 2 | Новый/Существующий клиент, Онлайн-каналы, Сервис Заявок, Kafka, Кредитный конвейер | Асинхронная обработка полной заявки на кредит | 1. После успешной предварительной оценки или по инициативе клиента (в ИБ), "Сервис Заявок" инициирует создание полной заявки. <br> 2. Сервис сохраняет заявку в своей БД и публикует событие `ЗаявкаСоздана` в топик Kafka. <br> 3. "Кредитный конвейер" получает событие и запускает процесс в BPMN-движке. |
| 3 | Существующий клиент, ИБ, Сервис Предодобренных Предложений | Получение предодобренного предложения | 1. "Сервис Предодобренных Предложений" периодически (раз в неделю, в ночное время) запускает скоринг по сегменту "надежных" клиентов (определяется внутренней политикой банка). <br> 2. Результаты (лимиты, ставки) сохраняются в БД сервиса с TTL (time-to-live) 1 месяц. <br> 3. Клиент в ИБ через API Gateway запрашивает свои предложения. <br> 4. Сервис отдает сохраненный и актуальный результат. |

### **Нефункциональные требования**
Ссылка на **Task2/FURPS_plus.md**. Ключевые требования: **P-02, +R-01, +R-02, +R-04, R-01, S-02/S-03**.

### **Решение**
Внедряется гибридная архитектура: синхронная для предварительных проверок и событийно-ориентированная для основной обработки.

**Новые компоненты:**
1.  **Сервис Заявок на Кредит (Loan Application Service):** Микросервис с **собственной БД (PostgreSQL)** для хранения онлайн-заявок и их статусов.
2.  **Сервис Предодобренных Предложений (Pre-approved Offer Service):** Новый микросервис с **собственной БД (PostgreSQL)**, отвечающий за периодический расчет и хранение персональных предложений для клиентов.
3.  **ABS API:** Низкоуровневый API-слой, предоставляющий гранулярные CRUD-операции для работы с сущностями АБС. Используется **только** внутренними системами (Скоринг, КК).
4.  **API Gateway:** Единая точка входа для **внешних** клиентов (Сайт, ИБ).

**Диаграммы:**
    **[Диаграмма контекста (C4 Level 2)](./img/C4_Context_Credit_Online.svg)**
    **[Диаграмма контейнеров (C4 Level 2)](./img/C4_Containers_Credit_Online.svg)**

**Описание решения:**
*   **Безопасность:** `Identity Provider` (Keycloak) и `API Gateway` для валидации JWT.
*   **Синхронный поток:** Для мгновенной обратной связи клиенту "Сервис Заявок" **напрямую** вызывает "Систему скоринга". Паттерн **Circuit Breaker** должен быть реализован в клиенте "Сервиса Заявок" (например, с помощью библиотеки Resilience4j) для предотвращения каскадных сбоев.
*   **Асинхронный поток:** Для основной обработки используется Kafka.
*   **Изоляция АБС:** `ABS API` инкапсулирует логику работы с АБС. Взаимодействие с `ABS API` от других внутренних сервисов (Система скоринга, Кредитный конвейер) должно осуществляться **напрямую**, в обход внешнего API Gateway. Политики **Rate Limiter** и **Circuit Breaker** реализуются на стороне клиентов.

### **Альтернативы**
**Альтернатива: Полностью синхронная интеграция:**
*   **Недостатки:** Сильная связанность, низкая отказоустойчивость.

### **Недостатки, Ограничения и Риски**
*   **Повышенная сложность:** Гибридная архитектура сложнее в эксплуатации.
*   **Операционные издержки:** Требуются компетенции для поддержки Kafka, Schema Registry, Keycloak.
*   **Риск: Недостаточная наблюдаемость:** Требуется качественное внедрение распределенной трассировки.
*   **Риск: Деградация производительности скоринга:** Пакетный расчет предодобренных предложений может замедлить онлайн-скоринг. Необходимо выполнять пакетные расчеты в часы минимальной нагрузки (ночью).